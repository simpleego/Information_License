# Locking 기법

-  **병행제어(Concurrency Control)**와 **2-Phase Commit(2PC)**

---

# 🎬 시나리오: “여러 사람이 동시에 사용하는 공유 냉장고”

회사 휴게실에 **공유 냉장고**가 있다고 상상해보자.  
여러 사람이 동시에 음식을 넣고 빼고 한다.  
이걸 데이터베이스라고 생각하면 이해가 훨씬 쉬워져.

---

# 🟡 1. 병행제어(Concurrency Control) = “냉장고에서 서로 부딪히지 않게 관리하기”

여러 사람이 동시에 냉장고를 열고 음식을 넣고 빼려고 하면 문제가 생긴다.

예를 들어:

- jong이 우유를 꺼내려고 문을 열었는데  
- 다른 사람이 동시에 우유를 꺼내면  
- 우유가 두 번 빠졌다고 기록될 수도 있다.

이런 혼란을 막기 위해 **병행제어**가 필요하다.

---

# 🔒 1-1. Lock(잠금) = “냉장고 문 잠그기”

jong이 냉장고에서 우유를 꺼내려고 한다면:

1. 냉장고 문을 잠근다 (Lock)
2. 우유를 꺼낸다
3. 문을 다시 연다 (Unlock)

이렇게 하면 **다른 사람이 동시에 우유를 건드릴 수 없다.**

데이터베이스도 똑같다.

- 어떤 데이터(우유)를 수정하려면 Lock을 건다  
- 작업이 끝나면 Unlock  
- Lock이 걸린 동안 다른 사람은 기다린다

👉 **Lock은 “데이터를 안전하게 다루기 위한 문 잠금장치”**

---

# 🔵 1-2. Lock이 없다면 어떤 일이 생길까?

- jong: 우유 1개 꺼냄  
- 다른 사람: 동시에 우유 1개 꺼냄  
- 냉장고에는 우유가 1개 있었는데  
- 기록에는 “우유가 2개 빠짐”으로 남음

이게 바로 **데이터 불일치 문제**  
병행제어가 필요한 이유다.

---

# 🟢 2. 2-Phase Commit(2PC) = “여러 냉장고에서 동시에 물건 꺼낼 때의 절차”

이번엔 회사에 **냉장고가 두 개** 있다고 해보자.

- A 냉장고: 우유  
- B 냉장고: 샌드위치  

jong은 “우유 + 샌드위치 세트”를 가져오려고 한다.  
그런데 **둘 중 하나만 성공하면 안 된다.**

- 우유만 가져오고 샌드위치는 못 가져오면?  
- 샌드위치만 가져오고 우유는 못 가져오면?

이건 말이 안 되지.

그래서 **두 냉장고가 동시에 성공해야만 최종 완료**되는 절차가 필요하다.  
이게 바로 **2-Phase Commit**이다.

---

# 🔶 2PC 단계 설명

## ✔ Phase 1: 준비 단계(Prepare)
jong이 두 냉장고에 말한다.

> “나 우유 하나, 샌드위치 하나 가져가도 될까? 준비됐어?”

각 냉장고는 확인한다.

- 재고 있는지  
- 문 잠금 가능한지  
- 문제가 없는지  

그리고 대답한다.

- “OK, 준비됨”  
- 또는 “안 됨, 재고 없음”

## ✔ Phase 2: 커밋 단계(Commit)
두 냉장고가 모두 “OK”라고 하면 jong이 말한다.

> “좋아, 그럼 둘 다 가져갈게!”

그리고 실제로 가져간다.

만약 하나라도 “안 됨”이라고 하면?

> “그럼 둘 다 취소!”

👉 **둘 다 성공하거나, 둘 다 취소된다.**

---

# 🎯 한 줄 요약

| 개념 | 일상적 의미 | 시나리오 |
|------|-------------|----------|
| **Lock** | 문 잠그기 | 내가 우유 꺼내는 동안 다른 사람 못 건드리게 |
| **병행제어** | 서로 부딪히지 않게 관리 | 여러 사람이 동시에 냉장고 사용 |
| **2-Phase Commit** | 여러 장소에서 동시에 성공해야만 확정 | 우유 + 샌드위치를 두 냉장고에서 동시에 가져오기 |

---

# 😊 jong이 이해하기 쉽게 다시 정리하면

- **Lock**은 “내가 작업하는 동안 건들지 마!”  
- **병행제어**는 “여러 사람이 동시에 써도 문제 없게 관리”  
- **2PC**는 “여러 곳에서 동시에 성공해야만 최종 확정”

---

원하면  
- 은행 계좌 이체 시나리오  
- 온라인 쇼핑 결제 시나리오  
- 게임 아이템 강화 시나리오  
같은 다른 버전으로도 다시 설명해줄게.
